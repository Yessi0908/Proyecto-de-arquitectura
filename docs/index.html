<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🌿 Invernadero Automatizado</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #d7f0d1; font-family: 'Poppins', sans-serif; }
    .card { border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .icon { font-size: 2rem; margin-right: 10px; }
    .alerta { font-weight: bold; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h1 class="text-center mb-4">🌿 Panel de Control del Invernadero</h1>

    <div class="row g-4">
      <div class="col-md-4">
        <div class="card p-3 bg-light">
          <h5><span class="icon">🌡️</span>Ambiente</h5>
          <p>Temperatura: <strong id="temp">-</strong></p>
          <p>Humedad: <strong id="hum">-</strong></p>
          <p>Estado bomba: <span class="alerta text-success">-</span></p>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-3 bg-light">
          <h5><span class="icon">🚨</span>Seguridad</h5>
          <p>Movimiento: <span id="mov">-</span></p>
          <p>Humo: <span id="humo" class="text-success">-</span></p>
          <p>Alerta: <span id="alerta" class="text-success">-</span></p>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-3 bg-light">
          <h5><span class="icon">🪪</span>Control de Acceso</h5>
          <p>Último acceso: <span id="horaAcceso">-</span></p>
          <p>Usuario: <strong id="usuario">-</strong></p>
          <p>Acceso: <span class="text-success">-</span></p>
        </div>
      </div>
    </div>

    <div class="card mt-4 p-4">
      <h5>📈 Registro de Temperatura y Humedad</h5>
      <canvas id="graficoAmbiente" height="100"></canvas>
    </div>

    <div class="card mt-4 p-4">
      <h5>🧾 Historial de eventos</h5>
      <table class="table table-hover">
        <thead class="table-success">
          <tr>
            <th>Fecha/Hora</th>
            <th>Evento</th>
            <th>Descripción</th>
            <th>Nivel</th>
          </tr>
        </thead>
        <tbody id="tablaEventos">
        </tbody>
      </table>
    </div>

    <div class="d-flex gap-2 mt-4">
      <button id="btnRefresh" class="btn btn-success">Refrescar datos</button>
      <a id="btnPdf" class="btn btn-primary" href="#" target="_blank">Descargar PDF</a>
    </div>
  </div>

  <script>
    // API base: reemplaza esto por la URL pública o la IP:PORT de tu backend.
    // Ejemplo local: const API_BASE = 'http://192.168.1.148:5000';
    // Si tu backend está en el mismo dominio/proxy, usa '' (cadena vacía) para rutas relativas.
    const API_BASE = '';

    const ctx = document.getElementById('graficoAmbiente').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['10:00','10:05','10:10','10:15','10:20'],
        datasets: [
          { label: 'Temperatura (°C)', data: [28,29,30,31,32], borderColor: 'red' },
          { label: 'Humedad (%)', data: [50,52,53,51,49], borderColor: 'blue' }
        ]
      }
    });

    async function fetchAmbiente(){
      try{
        const res = await fetch((API_BASE || '') + '/api/ambiente');
        const data = await res.json();
        if(!Array.isArray(data)) return;
        if(data.length>0){
          const last = data[0];
          document.getElementById('temp').innerText = (last.temperatura!==null)? last.temperatura + '°C' : '-';
          document.getElementById('hum').innerText = (last.humedad!==null)? last.humedad + '%' : '-';
          document.getElementById('horaAcceso').innerText = last.fecha || '-';
          document.getElementById('usuario').innerText = last.persona || '-';
        }
        const tabla = document.getElementById('tablaEventos');
        tabla.innerHTML = '';
        data.slice(0,10).forEach(r=>{
          const tr = document.createElement('tr');
          const fecha = document.createElement('td'); fecha.innerText = r.fecha || '';
          const evento = document.createElement('td'); evento.innerText = 'Ambiente';
          const desc = document.createElement('td'); desc.innerText = `T:${r.temperatura} H:${r.humedad}`;
          const nivel = document.createElement('td'); nivel.innerText = r.alerta || 'Normal';
          tr.appendChild(fecha); tr.appendChild(evento); tr.appendChild(desc); tr.appendChild(nivel);
          tabla.appendChild(tr);
        });
        // actualizar link PDF
        document.getElementById('btnPdf').href = (API_BASE || '') + '/api/report';
      }catch(e){
        console.error('error fetchAmbiente', e);
      }
    }

    document.getElementById('btnRefresh').addEventListener('click', ()=>{ fetchAmbiente(); });
    fetchAmbiente();
  </script>
</body>
</html>
